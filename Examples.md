

### Match errors with requests.

There is no reliable way to find the request corresponding to an entry in error\_log. There is no best practice for this that I can find. Apache 2.4 adds a request ID to the logs so that may be useful in the future when we upgrade. For now, the best method I can determine is to match by request time but that is unreliable because the errors do not always occur at exactly the same time. The access\_log timestamp is the time of request, the error\_log timestamp is the time of error. Also, the error_log can contain entries that are not directly

Requests may return correctly to the enduser (HTTP status 200) but still log errors. GBrowse is notorious for this behavior.

An example select, joining on epoch time and excluding requests with status 200:

  EXPLAIN QUERY PLAN    SELECT 
        a.remote_host, a.status, e.message, a.url 
      FROM
        access_log a, error_log e 
      WHERE 
        a.time_epoch = e.time_epoch
      AND
        a.status != 200;


In the follow example result, where the error\_log and access\_log were joined by epoch time, the error generated by the gbrowse\_img CGI script is associated with a request for a static png file. The gbrowse\_img CGI request was a few seconds earlier but the script ran for a bit before the error was recorded. The end result is a misleading association of request and error because the timestamps happened to match.

      remote_host = 10.10.9.101
           status = 200
          message = [Wed Nov  5 11:09:34 2014] gbrowse_img: \t(in cleanup) Can't call method "disconnect" on an undefined value at /var/www/mheiges.trichdb.org/cgi-lib/DAS/GUS.pm line 443 during global destruction.
              url = /gbrowse/i/trichdbaa/81e7983e26accb72eb1b04540f4d12c2.png

### Selecting by date ranges

Use strftime() to calculate epoch time integer (unixtime) from a given string and do comparisons against the `time_epoch` field. Be sure to use `'utc'` modifier.

      SELECT time from access_log 
      WHERE 
        time_epoch > strftime("%s", '2014-11-04 11:00:00', 'utc')
      AND
        time_epoch < strftime("%s", '2014-11-04 11:00:10', 'utc');

### Creating subtables

The SQLite virtual tables used by `cattoy` do not allow for column indexing, so queries will tend to be slow full table scans. Querying large log files, especially using table joins, can be too slow to be practical. If you are only interested in a specific subset of the logs, say those for a specific IP or time range, you can create smaller tables with the data subset and then query those.

      create table foo as select * from access\_log where remote\_host = '10.17.23.152';
      create table bar as select * from error\_log where remote\_host = '10.17.23.152';

      SELECT 
        a.remote_host, a.status, e.message, a.url 
      FROM
        foo a, bar e 
      WHERE 
        a.time_epoch = e.time_epoch;
      AND
        a.status != 200;

### Matching sql results in the log file

The `rowid` matches the line number in the log file.
